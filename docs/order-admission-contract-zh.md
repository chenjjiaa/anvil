# Order Admission Contract

_Gateway ↔ Matching Engine_

## 1. 文档目的与适用范围

本文档定义 Order Gateway 与 Matching Engine 之间关于订单接纳（Admission）的**责任边界、交互语义与失败处理约定**。
其目标是确保在分布式、并发、高负载环境下，订单在系统中的流转具备**明确的归属、可恢复性与可演进性**。

本契约仅约束 **Gateway → Matching** 这一链路，不涉及撮合算法、资金结算或持久化策略等下游实现细节。

---

## 2. 系统角色与基本假设

Gateway 是系统的入口节点，负责协议适配、基础校验与流量控制。
Matching Engine 是订单生命周期中第一个**权威处理节点**，负责决定订单是否被系统接纳并进入撮合域。

系统基于以下基本假设运行：

- Gateway 与 Matching 均为可横向扩展的无中心化组件
- 网络不可靠，请求可能丢失、重复或乱序
- 客户端可能重试任意失败请求
- 系统优先保证正确性，其次才是性能

---

## 3. 订单接纳的权威性划分

**Gateway 的成功转发不等于订单被系统接纳。**

订单是否被系统接纳，仅以 Matching Engine 的明确确认（ACK）为准。
在此之前，订单处于“未确认（Unconfirmed）”状态，其命运尚未被系统承诺。

Gateway 不拥有订单的权威状态，仅负责将请求安全地送达 Matching，并将 Matching 的反馈如实返回给上游。

---

## 4. ACK 的语义定义

Matching Engine 对 Gateway 的响应，必须明确表达以下语义之一：

- **Accepted**：订单已被 Matching 接管，进入撮合责任域
- **Rejected**：订单因不可恢复原因被拒绝
- **Overloaded / Unavailable**：当前无法接纳订单，请求可重试

ACK 表示的是**责任转移**，而非业务完成。
一旦返回 Accepted，订单的生命周期即由 Matching 负责，Gateway 不再对该订单承担任何重试或状态维护责任。

---

## 5. 投递语义与幂等性保证

Gateway 向 Matching 投递订单采用 **at-least-once** 语义。

为防止重复投递导致的逻辑错误，系统定义订单的幂等标识为：

> `(principal_id, nonce)`

Matching Engine 必须保证在其幂等窗口内，对相同标识的重复请求返回一致结果。
Gateway 的重试窗口不得超过 Matching 的幂等窗口，否则可能导致重复订单被错误接纳。

---

## 6. 顺序性与乱序处理约定

Gateway 不提供任何订单顺序保证。订单在 Gateway 被接收、验证并转发的顺序，与其最终被 Matching 处理或撮合的顺序之间，不存在语义上的因果关系。

在多实例 Gateway、网络抖动、重试及并发调度等条件下，请求可能以任意顺序到达 Matching。Gateway 不维护跨实例的全局时序状态，也不尝试对订单进行排序、延迟或重排。因此，Gateway 无法、也不应被视为系统的时间权威。

Matching 是订单处理顺序的唯一时间权威。“首单到达”的定义，仅以 Matching 实际接收到请求并将其纳入内部处理流程的时刻为准。Matching 不可能、也不需要感知是否存在一个“逻辑上更早但仍在网络中传输或尚未到达”的订单，请求一旦到达，即被视为当下可见的事件。

如业务对顺序性、公平性或确定性处理有要求（例如基于时间优先、序列号或 nonce 的严格约束），应由 Matching 在其内部基于显式字段和自身处理模型实现。顺序语义不应由 Gateway 层隐式提供，也不构成 Gateway 的职责边界。

> **时间权威（Time Authority）**
>
> 是指系统中唯一被认可、用于判定事件先后顺序的组件或阶段。在本系统中，时间权威不由 Gateway、客户端时间戳或网络到达顺序共同决定，而是由 Matching 在其内部接收并纳入处理流程的时刻所确立。任何在此之前的时间信息（如客户端时间、Gateway 接收时间或跨实例的相对顺序）仅作为参考元数据，不具备顺序语义。时间权威的集中化是为了避免在分布式环境中引入无法验证或无法维护的顺序承诺，从而保证撮合逻辑的确定性与可解释性。

---

## 7. 失败模型与责任归属

Matching 返回的失败需明确区分其性质：

- **不可恢复失败**（如参数非法、业务拒绝）
  该类失败由 Matching 明确返回，Gateway 原样转发并终止流程。

- **可恢复失败**（如超时、过载、临时不可用）
  Gateway 可将请求标记为未确认状态，允许客户端重试。

Gateway 不应自行推断失败原因，也不应对失败进行隐式重试。

---

## 8. 背压与过载信号

系统的真实处理能力由 Matching 决定。

当 Matching 处于过载状态时，必须通过明确的 Overload 信号通知 Gateway。
Gateway 在收到该信号后，应立即拒绝新请求，而非通过本地队列持续堆积。

Gateway 内部队列仅用于吸收短暂抖动，不承担调度或缓冲下游长期压力的职责。

---

## 9. Gateway 的状态约束

Gateway 允许维护以下类型的状态：

- 短生命周期、可丢失的缓存（如 replay cache）
- 流量控制与限速状态
- 协议层相关的临时上下文

Gateway **不得**维护以下状态：

- 订单的最终命运
- 跨实例一致的业务状态
- 需要恢复的权威数据

任何需要强一致或长期保存的状态，必须下沉至 Matching 或更下游系统。

---

## 10. 契约的演进原则

本契约允许向后兼容的扩展，但不允许模糊语义的收紧。

任何新增字段、状态或响应类型，必须保持以下原则：

- Gateway 行为可预测
- Matching 责任明确
- 客户端重试语义不被破坏

---

## 结语

Order Admission Contract 的存在，不是为了限制实现自由，而是为了防止系统在复杂性增长过程中失去边界感。

当 Gateway 与 Matching 严格遵守本契约时，系统将具备以下特性：

- 可水平扩展
- 可容错
- 可调试
- 可演进

这不是“写给现在看的文档”，而是**写给一年后、三年后系统维护者看的底层共识**。
